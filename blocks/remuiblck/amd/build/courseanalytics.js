"use strict";define(["jquery","core/chartjs","core/custom_interaction_events","block_remuiblck/events"],function(l,s,e,i){var r={PAGECOUNT:"[data-action-page-count]",PAGINATE:"[data-action-paginate]",NEXT:"[data-next]",PREVIOUS:"[data-previous]",CHARTPAGINATION:".analysis-chart-pagination",PAGES:"[data-region-pages]",TOGGLELABELS:"#togglelabels",PER_PAGE_FILTER:'[data-region="per-page-filter"]',FILTER_OPTION:"[data-value]"};window.analysisChart=null;var o,d=1,n=1;function c(a){var t={start:0,end:0};return null==o.labels||(o.labels.length<=a?(t.start=1,t.end=o.labels.length):(t.start=1==d?1:(d-1)*a+1,t.end=d*a,o.labels.length<t.end&&(t.end=o.labels.length))),t}function u(a,t){var e=c(t),n=e.start,i=e.end;l(a).find(r.PAGES).text(M.util.get_string("showingfromto","block_remuiblck",{start:n,to:i,total:o.labels.length})),analysisChart.data.labels=[],analysisChart.data.datasets.forEach(function(a){a.data=[]}),analysisChart.update();for(var s=n-1;s<=i;s++)analysisChart.data.labels.push(o.labels[s]),analysisChart.data.datasets.forEach(function(a,t){a.data.push(o.datasets[t].data[s])}),analysisChart.update()}function f(a,t){if(null!=o.labels){d=1;var e=c(t);e.start,e.end;l(a).find(r.CHARTPAGINATION).removeClass("d-none"),n=o.labels.length>t?Math.round(o.labels.length/t):1,u(a,t)}else l(a).find(r.CHARTPAGINATION).addClass("d-none")}function h(n){(function(a){var t=l(a).find("#coursecategorylist option:selected").data("id");return l.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=ger_course_anlytics_ajax&courseid="+t+"&sesskey="+M.cfg.sesskey})})(n).done(function(a){o=a,d=1,null!==analysisChart&&analysisChart.destroy(),a.error?(l(n).find("#highestactivity").html(""),l(n).find("#lowestactivity").html(""),l(n).find("#highestgrade").html("0"),l(n).find("#lowestgrade").html("0"),l(n).find("#averagegrade").html("0")):(l(n).find("#highestactivity").html(o.maxactivityname),l(n).find("#lowestactivity").html(o.minactivityname),l(n).find("#highestgrade").html(o.highest),l(n).find("#lowestgrade").html(o.lowest),l(n).find("#averagegrade").html(o.average));var t=l(n).find("#analysischart").get(0).getContext("2d"),e=[];null!=a.datasets&&a.datasets.forEach(function(a){e.push({data:[],backgroundColor:a.backgroundColor,label:a.label})}),t.canvas.height=400,analysisChart=new s(t,{data:{labels:[],datasets:e},type:"bar",options:{responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0},hover:{animationDuration:0},layout:{padding:{top:20}},legend:{position:"bottom",labels:{padding:20,fontSize:12}},animation:{duration:300,easing:"easeInOutQuad",onComplete:function(){var e=this.chart,i=e.ctx;i.font=s.helpers.fontString(s.defaults.global.defaultFontSize,s.defaults.global.defaultFontStyle,s.defaults.global.defaultFontFamily),i.textAlign="center",i.textBaseline="bottom",this.data.datasets.forEach(function(n,a){var t=e.controller.getDatasetMeta(a);1!=t.hidden&&t.data.forEach(function(a,t){var e=n.data[t];i.fillText(e,a._model.x,a._model.y-5)})})}},scales:{xAxes:[{display:!1,gridLines:{display:!0}}],yAxes:[{ticks:{beginAtZero:!0},gridLines:{display:!0}}]}}}),f(n,g(n))}).fail(function(a,t,e){l(n).find("div#analysis-chart-area").hide()})}var g=function(a){return l(a).find(r.PER_PAGE_FILTER).find(r.FILTER_OPTION+".active").data("value")};function t(t){!function(n){var a=l(n).find(r.PER_PAGE_FILTER);e.define(a,[e.events.activate]),a.on(e.events.activate,r.FILTER_OPTION,function(a,t){t.originalEvent.preventDefault();var e=l(a.target).closest(r.FILTER_OPTION);e.hasClass("active")||(l(a.target).trigger(i.COURSE_ANALYTICS_PAGE_FILTER_CHANGE),M.util.set_user_preference("courseanalyticsperpage",e.data("value")),f(n,e.data("value")))})}(t),l("body").on("click",t+" "+r.PAGINATE,function(){if(l(this).is(r.NEXT)){if(d==n)return;d++}else{if(!l(this).is(r.PREVIOUS))return;if(1==d)return;d--}var a=g(t);u(t,a)}),l("body").on("change",t+" #coursecategorylist",function(){h(t)})}return{init:function(a){l(document).ready(function(){t(a),l(a).find("#analysischart").length&&h(a)})}}});