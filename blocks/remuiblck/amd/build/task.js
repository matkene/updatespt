"use strict";function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}define(["jquery","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/fragment","block_remuiblck/modal_task_popup","block_remuiblck/events","block_remuiblck/task_filters","block_remuiblck/task_view"],function(a,n,r,t,e,c,i,o,s,d,l){function u(t){t.hide(),t.destroy()}function _(n,t,i){var o=function(t,e){var n=a(t).find(g.TASK+'[data-id="'+e+'"]');return n?n.find(g.TASK_SUBJECT).text():e}(n,t);e.create({type:e.types.SAVE_CANCEL,title:M.util.get_string("deletetask","block_remuiblck"),body:M.util.get_string("deletetaskmessage","block_remuiblck",o)},a("#create")).done(function(e){e.setSaveButtonText(M.util.get_string("ok","moodle")),e.getRoot().on(c.save,function(){S(t).done(function(t){if(1==t.status)return u(e),u(i),v(n),void function(t,e,n,i){0==a(t).find("."+e+g.TOASTER_CONTAINER).length&&a(t).append('<div class="toaster '+e+'" '+g.TOASTER_CONTAINER_ID+' role="alert"></div>');var o=a('\n        <div class="toast toast-just-text '+n+' toast-shadow">\n            <div class="toast-message">\n                '+i+"\n            </div>\n        </div>\n        ");a(t).find(g.TOASTER_CONTAINER).append(o),setTimeout(function(){o.addClass("show")},0),setTimeout(function(){o.removeClass("show"),setTimeout(function(){o.remove()},250)},2e3)}(n,"toast-top-center","toast-error",M.util.get_string("taskdeleted","block_remuiblck",o));r.exception({name:t.msg})}).fail(r.exception)}).on(c.cancel,function(){u(e)}),e.show()}).fail(r.exception)}function f(i,t){e.create({type:o.TYPE,templateContext:{new:-1==t}},a("#create")).done(function(n){n.show(),n.setBody(b(t)),n.getRoot().on(c.hidden,function(){u(n)}).on(s.TASK_SAVE,function(){if(n.valid_settings()){n.saving();var e=n.get_task_settings();-1!=t?(e.id=t,p(e).done(function(t){u(n),v(i)}).fail(function(t){n.saving(!1),r.exception(t)})):A(e).done(function(t){1!=e.notify?(u(n),v(i)):function(t,e,n){var i=2<arguments.length&&void 0!==n?n:null;E(t,e).done(i).fail(function(t){r.exception(t),null!=i&&i()})}(t,"create",function(){u(n),v(i)})}).fail(function(t){n.saving(!1),r.exception(t)})}}).on(s.TASK_DELETE,function(){_(i,t,n)}).on(s.TASK_CANCEL,function(){u(n)})})}function T(e){a("body").on("click",g.ADD_TASK,function(){f(e,-1)}).on("click",e+" "+g.TASK,function(t){a(t.target).is("input")?function(e,n,i){l.toggleTaskProcessing(e,!0),m(n,i).done(function(t){1!=t.status?(a(e+" "+g.TASK+'[data-id="'+n+'"]').find("input").prop("checked",!i),r.exception({name:t.msg}),l.toggleTaskProcessing(e)):v(e)}).fail(function(t){r.exception(t),a(e+" "+g.TASK+'[data-id="'+n+'"]').find("input").prop("checked",!i),l.toggleTaskProcessing(e)})}(e,a(this).data("id"),a(t.target).is(":checked")):a(t.target).is(g.TASK_SUBJECT)||(a(t.target).is(g.TASK_EDIT)||a(t.target).parent().is(g.TASK_EDIT))&&f(e,a(this).data("id"))})}var k,g=(_defineProperty(k={ADD_TASK:'[data-region="add-task"]',TASK:'[data-region="task-item"]',TASK_SUBJECT:'[data-toggle="collapse"]',TASK_EDIT:'[data-action="edit"]',TASK_POPUP:"[data-region='task-body']",TASK_DURATION_FILTER:'[data-region="task-duration-filter"]',TASK_STATUS_FILTER:'[data-region="task-status-filter"]',TASK_FILTER_OPTION:"[data-value]"},"TASK_SUBJECT",".item-title .panel-heading span"),_defineProperty(k,"PANEL",".panel"),_defineProperty(k,"PANEL_HEADING",".panel-heading"),_defineProperty(k,"PANEL_ACTIONS","panel-actions"),_defineProperty(k,"TOASTER_CONTAINER","[aria-task-toasters]"),_defineProperty(k,"TOASTER_CONTAINER_ID","aria-task-toasters"),_defineProperty(k,"TASK_PROCESSING",".task-processing"),k),A=function(t){return n.call([{methodname:"block_remuiblck_create_new_task",args:t}])[0]},p=function(t){return n.call([{methodname:"block_remuiblck_edit_task",args:t}])[0]},m=function(t,e){return n.call([{methodname:"block_remuiblck_complete_task",args:{id:t,status:e}}])[0]},S=function(t){return n.call([{methodname:"block_remuiblck_delete_task",args:{id:t}}])[0]},E=function(t,e){return n.call([{methodname:"block_remuiblck_task_notify_users",args:{id:t,type:e}}])[0]},b=function(t){return i.loadFragment("block_remuiblck","task_form",contextid,{taskid:t})},v=function(t){l.loadTasks(t,d.getTaskDuration(t),d.getTaskStatus(t))};return{init:function(t){a(document).ready(function(){T(t),function(t){var e=a(t).find(g.ADD_TASK).detach(),n=a(t).closest(g.PANEL).find(g.PANEL_HEADING),i=a(n).find("."+g.PANEL_ACTIONS);0==i.length&&(i=a('<div class="'+g.PANEL_ACTIONS+'"></div>'),n.prepend(i)),i.prepend(e),e.removeClass("d-none");var o=a(t).find(g.TASK_PROCESSING).detach();a(n).parent(g.PANEL).prepend(o)}(t)}),l.init(t),d.init(t)}}});