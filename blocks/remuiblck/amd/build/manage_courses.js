"use strict";define(["jquery","core/ajax","core/notification","core/modal_factory","core/modal_save_cancel","core/modal_events","block_remuiblck/manage_courses_view","block_remuiblck/manage_courses_filters","core/chartjs","block_remuiblck/jquery.dataTables","block_remuiblck/dataTables.bootstrap4"],function(r,n,o,a,e,c,t,s){var i=".remui-view-course-report",l="#wdm-userstats",d="#userstats-table",u="#userstats-table_wrapper .wdm-export-buttons",m=".wdm-manage-course-export-csv",g="#coursestats-chart",f="#userstats-table_filter input",b=".dropping-student-message",p=function(e){return n.call([{methodname:"block_remuiblck_get_course_report",args:{courseid:e}}])[0]},_=function(e,t,a,o,s){return n.call([{methodname:"block_remuiblck_get_dropping_off_students",args:{courseid:e,search:t,length:a,start:o,order:s}}])[0]},h=function(e,t){return n.call([{methodname:"block_remuiblck_export_dropping_off_students",args:{courseid:e,search:t}}])[0]};r("body").on("click",i,function(){event.preventDefault();var e=this,t=r("#create-modal");a.create({title:r(e).attr("title")},t).done(function(a){a.modal.addClass("modal-lg"),a.getRoot().on(c.hidden,function(){a.destroy()}).addClass("fade"),a.setBody('<i class="fa fa-circle-o-notch fa-spin fa-fw" aria-hidden="true"></i>'),p(r(e).data("course-id")).done(function(e){if(a.setBody(e),0!=a.getRoot().find(g).length){var t=a.getRoot().find(g)[0].getContext("2d");new Chart(t,{type:"doughnut",data:{labels:[M.util.get_string("studentcompleted","block_remuiblck"),M.util.get_string("inprogress","block_remuiblck"),M.util.get_string("yettostart","block_remuiblck")],datasets:[{backgroundColor:[studentcompletedcolor,inprogresscolor,yettostartcolor],data:[a.getRoot().find(g).data("studentcompleted"),a.getRoot().find(g).data("inprogress"),a.getRoot().find(g).data("yettostart")]}]},options:{legend:{display:!1}}})}}).fail(o.exception),setTimeout(a.show(),100)})}).on("click",l,function(){r(d).is(".dataTable")||r(d).DataTable({bPaginate:!0,bServerSide:!0,language:{searchPlaceholder:M.util.get_string("searchnameemail","block_remuiblck"),emptyTable:M.util.get_string("nostudentsenrolled","block_remuiblck")},dom:'<"wdm-export-buttons">frtip',initComplete:function(e,t){r(u).append("<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='"+r(this).data("course-id")+"'>"+M.util.get_string("exportcsv","block_remuiblck")+"</button>")},ajax:function(e,t,a){_(r(this).data("course-id"),e.search.value,e.length,e.start,e.order[0]).done(function(e){t(e)}).fail(o.exception)},columns:[{className:"pb-0 pt-0",data:"name"},{className:"pb-0 pt-0",data:"email"},{className:"pb-0 pt-0",data:"enroltimestart"},{className:"pb-0 pt-0",data:"lastaccess"}],rowCallback:function(e,t,a){a%2==0?r(e).addClass("bg-grey-100"):r(e).addClass("bg-grey-200")}})}).on("click",m,function(){h(r(this).data("course-id"),r(f).val()).done(function(e){var t=r("<a></a>");r("body").append(t),r(t).attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e.filedata)),r(t).attr("download",e.filename).hide()[0].click(),r(t).remove()}).fail(o.exception)}).on("click",b,function(){var s=this,e=r("#create-modal");a.create({type:a.types.SAVE_CANCEL,title:M.util.get_string("sendmessage","core_message")},e).done(function(o){o.setSaveButtonText(M.util.get_string("send","core_message")),o.setBody("<label>"+M.util.get_string("sendmessageto","core_message",r(r(s).parent("td").siblings()[0]).html())+'</label><textarea class="form-control message" rows="5" autocomplete="off"></textarea>'),o.getRoot().on(c.hidden,function(){o.destroy()}),o.getRoot().on(c.save,function(e){var t=r(s).data("student-id"),a=r(this).find(".message").val();""!=a&&jQuery.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/remui/request_handler.php?action=send_message_user_ajax&studentid="+t+"&message="+a+"&sesskey="+M.cfg.sesskey,success:function(e){o.destroy()},error:function(e,t,a){alert(a)}})}).addClass("modal-success fade"),o.modal.addClass("modal-center"),setTimeout(o.show(),100)})});return{init:function(e){r(document).ready(function(){t.init(e),s.init(e)})}}});